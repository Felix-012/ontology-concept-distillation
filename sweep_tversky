#!/usr/bin/env bash
# sweep_tversky.sh ─ sweep α / β settings and run image_retrieval.py
#
# Usage examples ──────────────────────────────────────────────────────────────
#   # use current Conda env, default grid & defaults
#   ./sweep_tversky.sh
#
#   # force a specific env and forward extra CLI flags to the retrieval script
#   ./sweep_tversky.sh -e retrieval-env -- --device cuda:0 --batch_size 64
#
# Options ─────────────────────────────────────────────────────────────────────
#   -e|--env ENV     Conda environment to use           (default: current env)
#   -b|--base FILE   Base YAML to clone/edit            (default: config.yml)
#   -o|--out DIR     Directory for generated configs    (default: runs)
#   -s|--script FILE Retrieval entry-point              (default: image_retrieval.py)
#   --               Everything after “--” is passed verbatim to the retrieval script
#
# Requirements ────────────────────────────────────────────────────────────────
#   • bash ≥ 4       • conda (mamba et al. also fine)
#   • yq v4+         https://github.com/mikefarah/yq  (brew/apt/pip install yq)
set -euo pipefail

# ─── defaults ────────────────────────────────────────────────────────────────
ENV_NAME="${CONDA_DEFAULT_ENV:-}"
BASE_CONFIG="/vol/ideadata/ce90tate/knowledge_graph_distance/configs/config_Consolidation_sweep.yml"
OUT_DIR="tmp_configs"

# ─── CLI parsing ─────────────────────────────────────────────────────────────
while [[ $# -gt 0 ]]; do
  case "$1" in
    -e|--env)   ENV_NAME="$2";        shift 2 ;;
    -b|--base)  BASE_CONFIG="$2";     shift 2 ;;
    -o|--out)   OUT_DIR="$2";         shift 2 ;;
    -s|--script)RETRIEVER="$2";       shift 2 ;;
    --)         shift; EXTRA_ARGS=("$@"); break ;;
    *) echo "Unknown option: $1" >&2; exit 1 ;;
  esac
done


export PYTHONPATH=$PWD
mkdir -p "$OUT_DIR"

# ─── sweep grid ──────────────────────────────────────────────────────────────
ALPHAS=(1.0 0.9 0.75 0.6 0.5 0.4 0.25 0.1 0.0)
BETAS=( 0.0 0.1 0.25 0.4 0.5 0.6 0.75 0.9 1.0)


for i in "${!ALPHAS[@]}"; do
  alpha=${ALPHAS[$i]}
  beta=${BETAS[$i]}

  tag="a${alpha}_b${beta}"
  cfg="${OUT_DIR}/config_${tag}.yml"

  # write modified YAML (numeric scalars, no quotes)
  yq -y ".hyperparameters.alpha = ${alpha} | .hyperparameters.beta = ${beta}" \
     "$BASE_CONFIG" > "$cfg"

  echo -e "\n\033[1m[RUN ${tag}]\033[0m $(date '+%F %T')" >&2
  python image_retrieval.py --config_path  "$cfg"
done
